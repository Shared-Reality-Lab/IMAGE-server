version: "3"

services:
    orchestrator:
        build:
            context: ./orchestrator
            dockerfile: Dockerfile
        image: "orchestrator:latest"
        env_file:
            - ./config/express-common.env
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
    supercollider:
        build:
            context: ./services/supercollider-images/supercollider-service
            dockerfile: Dockerfile
        image: "supercollider-service:latest"
        command: sclang -D ./example.scd
        volumes:
            - sc-store:/tmp/sc-store
    espnet-tts:
        build:
            context: ./services/espnet-tts
            dockerfile: Dockerfile
        image: "espnet-tts:latest"
        environment:
            - TORCH_DEVICE=cuda
        deploy:
            resources:
                reservations:
                    devices:
                    - driver: nvidia
                      capabilities: ["gpu", "utility", "compute"]
    hello-preprocessor:
        build:
            context: ./preprocessors/hello-preprocessor
            dockerfile: Dockerfile
        image: "hello-preprocessor:latest"
        env_file:
            - ./config/express-common.env
        labels:
            ca.mcgill.a11y.image.preprocessor: 1
            ca.mcgill.a11y.image.port: 8080
    hello-handler:
        build:
            context: ./handlers/hello-handler
            dockerfile: Dockerfile
        image: "hello-handler:latest"
        env_file:
            - ./config/express-common.env
        labels:
            ca.mcgill.a11y.image.handler: enable
    object-detection:
        build:
            context: ./preprocessors/object-detection
            dockerfile: Dockerfile
        image: "object-detection:latest"
        labels:
            ca.mcgill.a11y.image.preprocessor: 2
            ca.mcgill.a11y.image.port: 5000
    object-grouping:
        build:
            context: ./preprocessors/grouping
            dockerfile: Dockerfile
        image: "object-grouping:latest"
        labels:
            ca.mcgill.a11y.image.preprocessor: 3
            ca.mcgill.a11y.image.port: 5000
    scene-detection:
        build:
            context: ./preprocessors/scene
            dockerfile: Dockerfile
        image: "scene-detection:latest"
        labels:
            ca.mcgill.a11y.image.preprocessor: 1
            ca.mcgill.a11y.image.port: 5000
    hello-tts-handler:
        build:
            context: ./handlers/hello-tts-handler
            dockerfile: Dockerfile
        image: "hello-tts-handler:latest"
        env_file:
            - ./config/express-common.env
        labels:
            ca.mcgill.a11y.image.handler: enable
        volumes:
            - sc-store:/tmp/sc-store
    generic-tts-handler:
        build:
            context: ./handlers/generic-tts-handler
            dockerfile: Dockerfile
        image: "generic-tts-handler:latest"
        env_file:
            - ./config/express-common.env
        labels:
            ca.mcgill.cim.bach.atp.handler: enable
        volumes:
            - sc-store:/tmp/sc-store

volumes:
    sc-store:
